(function(){"use strict";!function(a,b){return"function"==typeof define&&define.amd?define("XgDataAdapter",["XgCommon"],b):a.XgDataAdapter=b(a.XgCommon)}(window,function(a){var b,c,d,e,f,g,h,j="xg-data-adapter.js",k="XgDataAdapter";return XgPlatform.XgLogger.info(function(){return j+" : load start"}),e=function(){var a=null;if(!window.XMLHttpRequest&&!window.ActiveXObject)return alert("Your browser doesn't support XMLHTTPRequest!!"),null;if(window.XMLHttpRequest)a=new XMLHttpRequest;else try{a=new ActiveXObject("Msxml2.XMLHTTP")}catch(b){a=new ActiveXObject("Microsoft.XMLHTTP")}return a},f=function(a){var b=e(),c=a.URL;return c.indexOf("?")>-1?c.length!==c.indexOf("?")+1&&(c+="&"):c+="?",c+="SP-IO="+a.dataType,void 0!==a.SOCD&&null!==a.SOCD&&(c+="&SP-SOCD="+a.SOCD),a.params&&(c+="&SP-PARAM="+encodeURIComponent(a.params)),c+="&_="+(new Date).getTime(),"BIN"===a.dataType&&(b.responseType="arraybuffer"),b.dtIDs=a.dtIDs,b.onreadystatechange=function(){return a.self.onReadyStateChange(b)},b.open("GET",c,a.async),b.setRequestHeader("Content-Type","text/plain"),b.send(),b},g=function(a){var b,c,d=e(),f=a.headers.length,g=a.URL;if("BIN"===a.dataType&&(d.responseType="arraybuffer"),d.dtIDs=a.dtIDs,d.onreadystatechange=function(){return a.self.onReadyStateChange(d)},d.open("POST",g,a.async),d.setRequestHeader("SP-IO",a.dataType),d.setRequestHeader("SP-SOCD",a.SOCD),d.setRequestHeader("SP-PARAM",encodeURIComponent(a.params)),f>0)for(b=0;f>b;++b)c=a.headers[b],d.setRequestHeader(c.name,c.value);return d.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),d.send(a.packet),d},d=function(b){var c,d,e,f,g,h,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M={columns:[],rows:[]},N=0,O=0,P=0;for(f=new Uint8Array(b);O<f.length-1;){if(N+=a.constant.PACKET_SIZE.PS+a.constant.PACKET_SIZE.PD+a.constant.PACKET_SIZE.PV+a.constant.PACKET_SIZE.PT,O+=a.constant.PACKET_SIZE.PS+a.constant.PACKET_SIZE.PD+a.constant.PACKET_SIZE.PV+a.constant.PACKET_SIZE.PT+a.constant.PACKET_SIZE.PI,B=f.subarray(N,O),M.dataID=String.fromCharCode.apply(null,B),N+=a.constant.PACKET_SIZE.PI,O+=a.constant.PACKET_SIZE.PC,C=f.subarray(N,O),t=String.fromCharCode.apply(null,C),N+=a.constant.PACKET_SIZE.PC+a.constant.PACKET_SIZE.PP+a.constant.PACKET_SIZE.PR,O+=a.constant.PACKET_SIZE.PP+a.constant.PACKET_SIZE.PR+a.constant.PACKET_SIZE.PL,D=f.subarray(N,O),o=parseInt(String.fromCharCode.apply(null,D),10),N+=a.constant.PACKET_SIZE.PL,O+=o,A=f.subarray(N,O),"S"===t||"C"===t){p=0,m=0,m+=a.constant.DATASET_SIZE.DSNM,n=A.subarray(p,m),M.datasetName=String.fromCharCode.apply(null,n),p+=a.constant.DATASET_SIZE.DSNM+a.constant.DATASET_SIZE.DSTP+a.constant.DATASET_SIZE.DSCR+a.constant.DATASET_SIZE.DSIU+a.constant.DATASET_SIZE.DSIP,m+=a.constant.DATASET_SIZE.DSTP+a.constant.DATASET_SIZE.DSCR+a.constant.DATASET_SIZE.DSIU+a.constant.DATASET_SIZE.DSIP+a.constant.DATASET_SIZE.DSVM,r=A.subarray(p,m),J=0;for(u in r)J+=parseInt(r[u],10)<<8*(r.length-1-u);p+=a.constant.DATASET_SIZE.DSVM+a.constant.DATASET_SIZE.DSVU+a.constant.DATASET_SIZE.DSRP,m+=a.constant.DATASET_SIZE.DSVU+a.constant.DATASET_SIZE.DSRP+a.constant.DATASET_SIZE.DSRC,s=A.subarray(p,m),H=0;for(u in s)H+=parseInt(s[u],10)<<8*(s.length-1-u);p+=a.constant.DATASET_SIZE.DSRC,m+=a.constant.DATASET_SIZE.DSCC,q=A.subarray(p,m),g=0;for(u in q)g+=parseInt(q[u],10)<<8*(q.length-1-u);if(p+=a.constant.DATASET_SIZE.DSCC+a.constant.DATASET_SIZE.DSCS,m+=a.constant.DATASET_SIZE.DSCS,J&&H&&g){for(u=0;g>u;++u){M.columns[u]={},m+=a.constant.COLUMN_SIZE.CNM,h=A.subarray(p,m),M.columns[u].name=decodeURI(escape(String.fromCharCode.apply(null,h))).replace(/\x00/g,""),p+=a.constant.COLUMN_SIZE.CNM+a.constant.COLUMN_SIZE.CVR+a.constant.COLUMN_SIZE.CVS,m+=a.constant.COLUMN_SIZE.CVR+a.constant.COLUMN_SIZE.CVS+a.constant.COLUMN_SIZE.CTP,l=A.subarray(p,m),M.columns[u].type=0;for(v in l)M.columns[u].type+=parseInt(l[v],10)<<8*(l.length-1-v);p+=a.constant.COLUMN_SIZE.CTP,m+=a.constant.COLUMN_SIZE.CPR,j=A.subarray(p,m),M.columns[u].prop=0;for(v in j)M.columns[u].prop+=parseInt(j[v],10)<<8*(j.length-1-v);p+=a.constant.COLUMN_SIZE.CPR,m+=a.constant.COLUMN_SIZE.CSZ,k=A.subarray(p,m),M.columns[u].size=0;for(v in k)M.columns[u].size+=parseInt(k[v],10)<<8*(k.length-1-v);p+=a.constant.COLUMN_SIZE.CSZ+a.constant.COLUMN_SIZE.CDS,m+=a.constant.COLUMN_SIZE.CDS}for(x=[],y=[],u=0;H>u;++u){M.rows[P+u]={},m+=a.constant.ROW_SIZE.RO,K=A.subarray(p,m),x[u]=0;for(v in K)x[u]+=parseInt(K[v],10)<<8*(K.length-1-v);p+=a.constant.ROW_SIZE.RO,m+=a.constant.ROW_SIZE.RS,L=A.subarray(p,m),y[u]=0;for(v in L)y[i]+=parseInt(L[v],10)<<8*(L.length-1-v);p+=a.constant.ROW_SIZE.RS}for(I=A.subarray(p,m+J),u=0;H>u;++u){F=0,E=0,G=I.subarray(x[u],x[u]+y[u]),E+=a.constant.ROW_SIZE.RJ,d=G.subarray(F,E),M.rows[P+u].crudType=0;for(v in d)M.rows[P+u].crudType+=parseInt(d[v],10)<<8*(d.length-1-v);for(F+=a.constant.ROW_SIZE.RJ,z=[],v=0;g>v;++v){z[v]=0,E+=a.constant.ROW_SIZE.RF,c=G.subarray(F,E);for(w in c)z[v]+=parseInt(c[w],10)<<8*(c.length-1-w);F+=a.constant.ROW_SIZE.RF}for(z[g]=G.length,M.rows[P+u].V=[],v=0;g>v;++v){if(M.rows[P+u].V[v]=null,E+=z[v+1]-z[v],e=G.subarray(F,E),1===M.columns[v].type)M.rows[P+u].V[v]=decodeURI(escape(String.fromCharCode.apply(null,e))).replace(/\x00/g,"");else if(2===M.columns[v].type)for(w in e)M.rows[P+u].V[v]+=parseInt(e[w],10)<<8*(e.length-1-w);F+=z[v+1]-z[v]}}P+=u}}N+=o}return M},c=function(){},b=function(b){return this.xgDataAdapterId=b,this.xgDataAdapterId||(this.xgDataAdapterId=a.createUUID()),this.async=!0,this.src=null,this.socd=null,this.params={},this.dataType=XgPlatform.XgDataType,this.cbTable={},this.requestType="POST",this.processSize=200,this.useFragment=!1,this.requestHeader=[],this},h=b.prototype,h.onReadyStateChange=function(b){var c,e,f,g=arguments;if(XgPlatform.XgLogger.debug(function(){return[k+".setDataAdapter",g]}),4===b.readyState)if(f=void 0,"BIN"===this.dataType?(c=b.response,c&&(f=d(c))):f=b.responseText,e=this.cbTable,200===b.status){if("function"!=typeof e.func)throw new a.Error("[onreadystatechange]Response: "+b.responseText,j);e.func(e.id,f,"all"),f=null}else{if("function"!=typeof e.func)throw new a.Error("[onreadystatechange]Error: "+b.statusText,j);e.func(e.id,"[onreadystatechange]Error ["+b.statusText+"]","all")}return this},h.CRUD=function(b,c,d,e,h){var i,l,m=arguments;if(XgPlatform.XgLogger.debug(function(){return[k+".CRUD",m]}),c=c.toUpperCase(),this.cbTable={id:d,func:h,type:this.dataType},i=this.cbTable,void 0===b||null===b){if(void 0===this.src||null===this.src)throw new a.Error("Error: Invaild server URL!",j);b=this.src}if("undefined"!=typeof Worker&&this.useFragment===!0&&"R"===c)"undefined"==typeof l&&(l=new Worker(XgPlatform.XgPath+"/xg-data-worker.js")),l.onmessage=function(b){var c=i.func,d=i.id,e=b.data.result,f=b.data.step;if(200!==b.data.code||"column"!==f&&"row"!==f&&"message"!==f){if("function"==typeof c)return c(d,"[onmessage]Error ["+e+"]",f);throw new a.Error("[onmessage]Error: "+e,j)}if("function"==typeof c)return c(d,e,f);throw new a.Error("[onmessage]Response: "+e,j)},l.onerror=function(a){return console.log("worker ERROR: "+a.filename+", "+a.message)},l.postMessage({step:"select",async:this.async,dataType:this.dataType,requestType:this.requestType,dtIDs:d,packet:e,unitSize:this.processSize,params:this.getParams(),headers:this.requestHeader,SOCD:this.socd,URL:b});else if("C"===c||"U"===c||"D"===c)g({self:this,async:this.async,dataType:this.dataType,dtIDs:d,packet:e,params:this.getParams(),headers:this.requestHeader,SOCD:this.socd,URL:b});else{if("R"!==c)throw new a.Error("Invalid CRUD mode.",j);if("GET"===this.requestType)f({self:this,async:this.async,dataType:this.dataType,dtIDs:d,params:this.getParams(),SOCD:this.socd,URL:b});else{if("POST"!==this.requestType)throw new a.Error("Invalid request mode.",this.requestType);g({self:this,async:this.async,dataType:this.dataType,dtIDs:d,packet:e,params:this.getParams(),headers:this.requestHeader,SOCD:this.socd,URL:b})}}return this},h.getDataType=function(){var a=arguments;return XgPlatform.XgLogger.debug(function(){return[k+".getDataType",a]}),(void 0===this.dataType||null===this.dataType)&&(this.dataType="JSON",XgPlatform.XgDataType=this.dataType),this.dataType},h.setDataType=function(a){var b,c=arguments;if(XgPlatform.XgLogger.debug(function(){return[k+".setDataType",c]}),a=a.toUpperCase(),"XML"===a||"JSON"===a||"BIN"===a||"HTML5JSON"===a)if(b=e(),"BIN"===a){try{b.responseType=""}catch(d){console.log(d.message),a="JSON"}this.dataType=a}else this.dataType=a;else this.dataType="JSON";return XgPlatform.XgDataType=this.dataType,this},h.getParams=function(){var a,b,c,d,e,f="",g=arguments;if(XgPlatform.XgLogger.debug(function(){return[k+".getParams",g]}),void 0!==this.params&&null!==this.params){"undefined"==typeof Array.isArray&&(Array.isArray=function(a){return Object.prototype.toString.call("[object Array]"===a)}),d=this.params;for(b in d)if(e=d[b],c=e.length,Array.isArray(e))for(a=0;c>a;++a)f+=null===e[a]||void 0===e[a]?","+b+"=":","+b+"="+e[a];else f+=","+b+"="+e}return 0===f.indexOf(",")&&(f=f.substring(1)),f.replace(/%20/g,"+"),f},h.setParams=function(a){var b,c,d,e,f,g,h=arguments;if(XgPlatform.XgLogger.debug(function(){return[k+".setParams",h]}),a){if("string"==typeof a){for(f={},b=a.split("&"),e=b.length,d=0;e>d;++d)c=b[d].split("="),""!==c[0]&&""!==c[1]&&(f[c[0]]=c[1]);a=f}Object.assign?this.params=Object.assign({},this.params,a):(g=function(){var a,b,c={};if(!arguments.length)return c;for(b=arguments.length,d=0;b>=d;++d)for(a in arguments[d])c[a]=arguments[d][a];return c},this.params=g(this.params,a))}return this},h.resetParams=function(){return XgPlatform.XgLogger.debug(function(){return[k+".resetParams"]}),this.params={},this},h.getSOCD=function(){var a=arguments;return XgPlatform.XgLogger.debug(function(){return[k+".getSOCD",a]}),this.socd},h.setSOCD=function(b){var c=arguments;if(XgPlatform.XgLogger.debug(function(){return[k+".setSOCD",c]}),!(-1<b.indexOf("=")&&(-1<b.indexOf("O:")||-1<b.indexOf("I:"))))throw new a.Error("Invalid SOCD.",j);return this.socd=b,this.socd.trim(),this},h.getSrc=function(){var a=arguments;return XgPlatform.XgLogger.debug(function(){return[k+".getSrc",a]}),this.src},h.setSrc=function(a){var b=arguments;return XgPlatform.XgLogger.debug(function(){return[k+".setSrc",b]}),this.src=a,this},h.getAsyncStatus=function(){var a=arguments;return XgPlatform.XgLogger.debug(function(){return[k+".getAsyncStatus",a]}),this.async},h.setAsyncStatus=function(a){var b=arguments;return XgPlatform.XgLogger.debug(function(){return[k+".setAsyncStatus",b]}),this.async=a,this},h.getUseFragment=function(){var a=arguments;return XgPlatform.XgLogger.debug(function(){return[k+".getUseFragment",a]}),this.useFragment},h.setUseFragment=function(a){var b=arguments;return XgPlatform.XgLogger.debug(function(){return[k+".setUseFragment",b]}),this.useFragment=a,this},h.getXgPath=function(){var a=arguments;return XgPlatform.XgLogger.debug(function(){return[k+".getXgPath",a]}),XgPlatform.XgPath},h.setXgPath=function(a){var b=arguments;return XgPlatform.XgLogger.debug(function(){return[k+".setXgPath",b]}),XgPlatform.XgPath=a,this},h.getProcessSize=function(){var a=arguments;return XgPlatform.XgLogger.debug(function(){return[k+".getProcessSize",a]}),this.processSize},h.setProcessSize=function(a){var b=arguments;return XgPlatform.XgLogger.debug(function(){return[k+".setProcessSize",b]}),this.processSize=a>2e3?2e3:200>a?200:a,this},h.getRequestType=function(){var a=arguments;return XgPlatform.XgLogger.debug(function(){return[k+".getRequestType",a]}),this.requestType},h.setRequestType=function(a){var b=arguments;return a=a.toUpperCase(),XgPlatform.XgLogger.debug(function(){return[k+".setRequestType",b]}),("GET"===a||"POST"===a)&&(this.requestType=a),this},h.addRequestHeader=function(a,b){var c={name:a,value:b},d=arguments;return XgPlatform.XgLogger.debug(function(){return[k+".addRequestHeader",d]}),this.requestHeader.push(c),c=null,this},XgPlatform.XgLogger.info(function(){return j+" : load end"}),b})}).call(this);