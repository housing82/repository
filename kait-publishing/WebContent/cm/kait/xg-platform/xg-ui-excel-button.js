(function(){"use strict";!function(a,b){return"function"==typeof define&&define.amd?define("XgUIExcelButton",["jquery","json3","XLSX","XgCommon","XgDataSet","XgDataTable","XgUICommon","XgUIButton","FileSaver"],b):a.XgUIExcelButton=b(a.jQuery,a.JSON,a.XLSX,a.XgCommon,a.XgDataSet,a.XgDataTable,a.XgUICommon)}(window,function(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q;return q="xg-ui-excel-button.js",XgPlatform.XgLogger.info(function(){return q+" : load start"}),j=function(a,b){var c,d,e,f,g,h;for(h=new Array(a.getColumnCount()),f=Object.keys(b),c=d=0,g=f.length;g>d;c=++d)e=f[c],h[a.getColumnIndex(e)]=b[e];return h},m=function(a){var b,c,d;for(b=0,c="",d=10240;b<a.byteLength/d;)c+=String.fromCharCode.apply(null,new Uint8Array(a.slice(b*d,b*d+d))),++b;return c+=String.fromCharCode.apply(null,new Uint8Array(a.slice(b*d)))},p=function(a){var b,c,d;for(b=new ArrayBuffer(a.length),d=new Uint8Array(b),c=0;c!==a.length;)d[c]=255&a.charCodeAt(c),c++;return b},k=function(a){var b,d,e,f,g,h,i,j,k,l,m,n,o;for(i=a.body,o={},l={s:{c:0,r:0},e:{c:a.getColumnCount(),r:a.getRowCount()+1}},d=0,m=a.header,h=j=0,k=m.length;k>j;h=++j)g=m[h],e={v:a.getColumnName(h)},f=c.utils.encode_cell({c:h,r:0,t:"s"}),o[f]=e;for(;d!==i.length;){for(b=0;b!==i[d].length;)l.s.r>d&&(l.s.r=d),l.s.c>b&&(l.s.c=b),l.e.r<d&&(l.e.r=d),l.e.c<b&&(l.e.c=b),e={v:i[d][b]},null!==(n=e.v)&&void 0!==n&&(f=c.utils.encode_cell({c:b,r:d+1}),"number"==typeof e.v?e.t="n":"boolean"==typeof e.v?e.t="b":e.v instanceof Date?(e.t="n",e.z=c.SSF._table[14]):e.t="s",o[f]=e),b++;d++}return l.s.c<a.getColumnCount()&&(o["!ref"]=c.utils.encode_range(l)),o},n=function(a,b,c){return a.parent.$eventEmitter.trigger("xg-bind-event",{uuid:void 0,eventName:"addRow",rowIdx:a.getRowCount(),value:b.rows,rowValue:b.xgRows,xgDataTableId:a.getId()}),c&&"function"==typeof c?c():void 0},o=function(a,b,c){return saveAs(new Blob([p(a)],{type:"application/octet-stream"}),b+".xlsx"),c&&"function"==typeof c?c():void 0},l=function(a,b){var c,d,e,f,g,h;for(h=new Array(a.getColumnCount()),f=Object.keys(b),c=d=0,g=f.length;g>d;c=++d)e=f[c],"*xgRowStatus"!==e&&"xgSequence"!==e&&(h[a.getColumnIndex(e)]=b[e]);return h},h=function(){return this instanceof h?(this.SheetNames=[],this.Sheets={},this):new h},a.fn.xgExcelButton=function(){var e,f,i,p,q,r,s,t,u,v,w,x,y,z,A,B;if(w=this,q=a(this),x=arguments,XgPlatform.XgLogger.debug(function(){return["XgUIExcelButton",w.selector||w,x]}),q.data("xg-uuid")||(g.setUUID(q),q.attr("data-xg-excel-button","")),"string"==typeof arguments[0]){if("xgInitOption"===arguments[0])return q.data("xg-init-option");if("xgBindOption"===arguments[0])return q.data("xg-bind-option");"destroy"===arguments[0]&&(z=q.data("xg-uuid"),a("span[data-xg-ref-uuid='"+z+"']").remove(),a("form[id='xg-form-"+z+"']").remove(),a("iframe[id='xg-iframe-"+z+"']").remove())}if(arguments[0]instanceof Object&&arguments[0].xgBindOption&&(v={},r=a(this).data("xg-bind-option"),a.extend(!0,v,r,arguments[0].xgBindOption),a(this).data("xg-bind-option",v),r=v,"function"==typeof r.start&&(w.startCb=r.start),"function"==typeof r.end&&(w.endCb=r.end),delete arguments[0].xgBindOption),arguments[0]instanceof Object&&arguments[0].xgInitOption){if(v={},u=a(this).data("xg-init-option"),u||(u={supportOlderBrowser:!0,actionUrl:"/XG/ix-import.xlsx",xgUIWorkerUrl:"./xg-platform",xlsxUrl:"./lib/js-xlsx/dist",unsupportBrowser:function(){return alert("This browser dosen't support xg-excel-button feature.( Modern browser or IE 10+ )"),!1}},"export"===arguments[0].xgInitOption.type&&(u.actionUrl="/XG/ix-export.xlsx")),a.extend(!0,v,u,arguments[0].xgInitOption),v.actionUrl&&v.actionUrl.lastIndexOf("/")===v.actionUrl.length-1&&(v.actionUrl=v.actionUrl.substr(0,v.actionUrl.length-1)),a(this).data("xg-init-option",v),u=v,A=u.xgDataSet,"string"==typeof A&&(A=d.getDataSet(A)),B=u.xgDataTable,"string"==typeof B&&(B=A.getDataTable(B)),delete arguments[0].xgInitOption,"import"===u.type){if(z=q.data("xg-uuid"),y=u.text||"엑셀 가져오기",d.isOlderBrowser()){if(!u.supportOlderBrowser)return void u.unsupportBrowser();a("#xg-form-"+z).remove(),i=a("<form style='display:inline-block' id='xg-form-"+z+"' name='xg-form-"+z+"' encType='multipart/form-data' action='"+v.actionUrl+"' target='xg-iframe-"+z+"' method='POST' accept-charset='UTF-8'><input type='hidden' name='DS_HEADER'><div style='display:inline-block;'>"+y+'<input type="file" name="EXCEL_FILE" style="position:absolute;top:0;right:0;margin:0;opacity:0;-ms-filter:\'alpha(opacity=0)\';direction:ltr;cursor:pointer;width:100%;height:100%;display:block;"></div></form>'+("<iframe style='display:none;' id='xg-iframe-"+z+"' name='xg-iframe-"+z+"'></iframe>")),q.before(i),q.css("display","none"),p=i.find("div"),p.css({position:"relative"}),e=p.find('input[type="file"]'),e.on("change",function(){var c,e;return w.startCb&&"function"==typeof w.startCb&&w.startCb(),c=a("#xg-form-"+z),e=a("#xg-iframe-"+z),e.off("load"),e.load(function(){var c,e,f,g,h,i;if(i=a(this.contentDocument).find("body > pre"),i.length||(i=a(this.contentDocument).find("body")),e=b.parse(i.html()),e["@issuccess"]){for(f=[],h=e.body.row,c=d.constant.STATUS.INSERT,g=h.length;g--;)h[g]["*xgRowStatus"]=c,f.unshift(j(B,h[g]));if(A.$eventEmitter.trigger("xg-bind-event",{uuid:z,eventName:"addRow",rowIdx:B.getRowCount(),value:h,rowValue:f,xgDataTableId:B.getId()}),w.endCb&&"function"==typeof w.endCb)return w.endCb()}else alert(e.message||"수신된 데이터가 올바르지 않습니다."),w.endCb&&"function"==typeof w.endCb&&w.endCb()}),i.find('input[name="DS_HEADER"]').val(b.stringify(A.makeJSONHeader(B.getId()))),c.submit()}),w.target=p}else p=a("<button type='button'>"+y+"</button>"),p.attr("data-xg-ref-uuid",q.data("xg-uuid")),q.before(p),q.css("display","none"),p.off("click"),p.on("click",function(){var a,b;return b=q.clone(!0),a=q.before()[0],b.on("change",t),b.trigger("click")}),w.target=p;t=function(a){var e,f,g;return w.startCb&&"function"==typeof w.startCb&&w.startCb(),a.stopPropagation(),e=a.target.files[0],g=new FileReader,f=g.readAsBinaryString?!0:!1,g.onload=function(a){var e,g,h,i,j,k,o,p,q,r,s,t,u,x,y,z,A,C,D,E,F,G,H,I,J,K,L,M,N,O;if(window.Worker)return g=function(a){return"e"===a.data.t?(alert(a.data.d),w.endCb&&"function"==typeof w.endCb&&w.endCb(),!1):n(B,b.parse(a.data.d),w.endCb)},M=new d.WorkerTask(v.xgUIWorkerUrl+"/xg-ui-worker.js",g,"import",[f,v.xlsxUrl+"/xlsx.full.min.js",B.header,a.target.result]),window.XgPlatform.threadPool.addWorkerTask(M);for(k=a.target.result,f?L=c.read(k,{type:"binary"}):(e=m(k),L=c.read(btoa(e),{type:"base64"})),G=L.Sheets[L.SheetNames[0]],H=G["!ref"].split(":"),i=Object.keys(G),p=[],q=0,s=i.length;s>q;q++)h=i[q],"!ref"!==h&&(z=parseInt(h.replace(/[^0-9]/g,""),10),1===z&&p.push({key:h.replace(/\B[0-9]/g,""),value:G[h].v}));for(K=parseInt(H[0].replace(/[^0-9]/g,""),10),I=parseInt(H[1].replace(/[^0-9]/g,""),10),F=[],J=r=A=K+1,C=I;C>=A?C>=r:r>=C;J=C>=A?++r:--r){for(D={},x=0,t=p.length;t>x;x++)o=p[x],j=G[o.key+J],j&&(D[o.value]=j.v);Object.keys(D)&&F.push(D)}for(O=[],E=y=0,u=F.length;u>y;E=++y)D=F[E],F[E]["*xgRowStatus"]=d.constant.STATUS.INSERT,N=l(bindedDataTable,D),O.push(N);return k={rows:F.reverse(),xgRows:O.reverse()},n(B,k,w.endCb),w.endCb&&"function"==typeof w.endCb?w.endCb():void 0},f?g.readAsBinaryString(e):g.readAsArrayBuffer(e)}}if("export"===u.type)if(y=u.text||"엑셀 내보내기",f=a("<i class='fa fa-file-excel-o'></i>"),q.text(y),w.target=q,s=u.fileName||"xg-excel-export",q.off("click"),d.isOlderBrowser()){if(!u.supportOlderBrowser)return void u.unsupportBrowser();s+=".xlsx",z=q.data("xg-uuid"),a("span[data-xg-ref-uuid='"+z+"']").remove(),i=a("<span data-xg-ref-uuid='"+z+"'><div style='display:none;'>"+("<form id='xg-form-"+z+"' name='xg-form-"+z+"' action='"+v.actionUrl+"' target='xg-iframe-"+z+"' method='POST'>")+"<input type='text' name='DATA_SET'>"+("<input type='text' name='fileName' value='"+s+"'>")+"</form>"+("<iframe id='xg-iframe-"+z+"' name='xg-iframe-"+z+"'></iframe>")+"</div></span>"),q.before(i),q.off("click"),q.click(function(){var c,d;return w.startCb&&"function"==typeof w.startCb&&w.startCb(),d=b.stringify(A.makeJSONExportData(B.getId())),i.find('input[name="DATA_SET"]').val(d),c=a("#xg-form-"+z),c.submit(),w.endCb&&"function"==typeof w.endCb?w.endCb():void 0})}else q.on("click",function(){var a,e,f,g,i,j;return w.startCb&&"function"==typeof w.startCb&&w.startCb(),window.Worker?(e=!0,a=function(a){var c;return"e"===a.data.t?(alert(a.data.d),w.endCb&&"function"==typeof w.endCb&&w.endCb(),!1):(c=b.parse(a.data.d),o(c,s,w.endCb))},i=new d.WorkerTask(v.xgUIWorkerUrl+"/xg-ui-worker.js",a,"export",[e,v.xlsxUrl+"/xlsx.full.min.js",B.header,B.body,{fileName:s}]),window.XgPlatform.threadPool.addWorkerTask(i)):(f=new h,j=k(B,{fileName:s}),f.SheetNames.push(s),f.Sheets[s]=j,g=c.write(f,{bookType:"xlsx",bookSST:!0,type:"binary"}),o(g,s,w.endCb))});return w.target.xgButton.apply(w.target,arguments)}},i=function(){var b,c;return b=Array.prototype.slice.call(arguments,0,1)[0],c=Array.prototype.slice.call(arguments,1,2)[0],c||a(b).xgExcelButton(),c&&a(b).xgExcelButton(c),a(b)},a(document).ready(function(){var b,c,d,e,f,g,h,i;for(h=a("[data-xg-excel-button]"),i=[],e=f=0,g=h.length;g>f;e=++f)d=h[e],b=a(d),c=b.data("xg-option"),i.push(c?b.xgExcelButton(c):void 0);return i}),XgPlatform.XgLogger.info(function(){return q+" : load end"}),i})}).call(this);