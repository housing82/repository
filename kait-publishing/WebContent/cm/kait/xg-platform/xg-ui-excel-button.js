(function(){"use strict";!function(a,b){return"function"==typeof define&&define.amd?define("XgUIExcelButton",["jquery","json3","XLSX","XgCommon","XgDataSet","XgDataTable","XgUICommon","XgUIButton","FileSaver"],b):a.XgUIExcelButton=b(a.jQuery,a.JSON,a.XLSX,a.XgCommon,a.XgDataSet,a.XgDataTable,a.XgUICommon)}(window,function(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r="xg-ui-excel-button.js";return XgPlatform.XgLogger.info(function(){return r+" : load start"}),j=function(a,b){var c,d,e,f=Object.keys(b),g=new Array(a.getColumnCount());for(c=0,d=f.length;d>c;++c)e=f[c],g[a.getColumnIndex(e)]=b[e];return g},n=function(a){for(var b=0,c="",d=10240;b<a.byteLength/d;)c+=String.fromCharCode.apply(null,new Uint8Array(a.slice(b*d,b*d+d))),++b;return c+=String.fromCharCode.apply(null,new Uint8Array(a.slice(b*d)))},q=function(a){for(var b=new ArrayBuffer(a.length),c=0,d=new Uint8Array(b);c!==a.length;)d[c]=255&a.charCodeAt(c),c++;return b},k=function(a){var b,d,e,f,g,h,i,j,k=0,l=a.body,m={s:{c:0,r:0},e:{c:a.getColumnCount(),r:a.getRowCount()+1}},n={};for(j=a.header,h=0,i=j.length;i>h;++h)g=j[h],d={v:a.getColumnName(h)},e=c.utils.encode_cell({c:h,r:0,t:"s"}),n[e]=d;for(;k!==l.length;){for(b=0;b!==l[k].length;)m.s.r>k&&(m.s.r=k),m.s.c>b&&(m.s.c=b),m.e.r<k&&(m.e.r=k),m.e.c<b&&(m.e.c=b),d={v:l[k][b]},f=d.v,null!==f&&void 0!==f&&(e=c.utils.encode_cell({c:b,r:k+1}),"number"==typeof d.v?d.t="n":"boolean"==typeof d.v?d.t="b":d.v instanceof Date?(d.t="n",d.z=c.SSF._table[14]):d.t="s",n[e]=d),b++;k++}return m.s.c<a.getColumnCount()&&(n["!ref"]=c.utils.encode_range(m)),n},o=function(a,b,c){a.parent.$eventEmitter.trigger("xg-bind-event",{uuid:void 0,eventName:"addRow",rowIdx:a.getRowCount(),value:b.rows,rowValue:b.xgRows,xgDataTableId:a.getId()}),c&&"function"==typeof c&&c()},p=function(a,b,c){saveAs(new Blob([q(a)],{type:"application/octet-stream"}),b+".xlsx"),c&&"function"==typeof c&&c()},l=function(a,b){var c,d,e,f=Object.keys(b),g=new Array(a.getColumnCount());for(c=0,d=f.length;d>c;++c)e=f[c],"*xgRowStatus"!==e&&"xgSequence"!==e&&(g[a.getColumnIndex(e)]=b[e]);return g},m=function(c,d,e,f,g,h){c+=".xlsx";var i,j=d.data("xg-uuid");a("span[data-xg-ref-uuid='"+j+"']").remove(),i=a("<span data-xg-ref-uuid='"+j+"'><div style='display:none;'>"+("<form id='xg-form-"+j+"' name='xg-form-"+j+"' action='"+e.actionUrl+"' target='xg-iframe-"+j+"' method='POST'>")+"<input type='text' name='DATA_SET'>"+("<input type='text' name='fileName' value='"+c+"'>")+"</form>"+("<iframe id='xg-iframe-"+j+"' name='xg-iframe-"+j+"'></iframe>")+"</div></span>"),d.before(i),d.off("click"),d.click(function(){var c,d=a("#xg-form-"+j);f.startCb&&"function"==typeof f.startCb&&f.startCb(),c=b.stringify(g.makeJSONExportData(h.getId())),i.find('input[name="DATA_SET"]').val(c),d.submit(),f.endCb&&"function"==typeof f.endCb&&f.endCb()})},h=function(){return this instanceof h?(this.SheetNames=[],this.Sheets={},this):new h},a.fn.xgExcelButton=function(){var e,f,i,q,r,s,t,u,v,w,x,y,z,A=a(this),B=this,C=arguments;if(XgPlatform.XgLogger.debug(function(){return["XgUIExcelButton",B.selector||B,C]}),A.data("xg-uuid")||(g.setUUID(A),A.attr("data-xg-excel-button","")),"string"==typeof arguments[0]){if("xgInitOption"===arguments[0])return A.data("xg-init-option");if("xgBindOption"===arguments[0])return A.data("xg-bind-option");"destroy"===arguments[0]&&(x=A.data("xg-uuid"),a("span[data-xg-ref-uuid='"+x+"']").remove(),a("form[id='xg-form-"+x+"']").remove(),a("iframe[id='xg-iframe-"+x+"']").remove())}if(arguments[0]instanceof Object&&arguments[0].xgBindOption&&(v={},r=a(this).data("xg-bind-option"),a.extend(!0,v,r,arguments[0].xgBindOption),a(this).data("xg-bind-option",v),r=v,"function"==typeof r.start&&(B.startCb=r.start),"function"==typeof r.end&&(B.endCb=r.end),delete arguments[0].xgBindOption),arguments[0]instanceof Object&&arguments[0].xgInitOption){if(v={},u=a(this).data("xg-init-option"),u||(u={supportOlderBrowser:!0,actionUrl:"/XG/ix-import.xlsx",xgUIWorkerUrl:"./xg-platform",xlsxUrl:"./lib/js-xlsx/dist",unsupportBrowser:function(){return alert("This browser dosen't support xg-excel-button feature.( Modern browser or IE 10+ )"),!1}},"export"===arguments[0].xgInitOption.type&&(u.actionUrl="/XG/ix-export.xlsx")),a.extend(!0,v,u,arguments[0].xgInitOption),v.actionUrl&&v.actionUrl.lastIndexOf("/")===v.actionUrl.length-1&&(v.actionUrl=v.actionUrl.substr(0,v.actionUrl.length-1)),a(this).data("xg-init-option",v),u=v,y=u.xgDataSet,"string"==typeof y&&(y=d.getDataSet(y)),z=u.xgDataTable,"string"==typeof z&&(z=y.getDataTable(z)),delete arguments[0].xgInitOption,"import"===u.type){if(x=A.data("xg-uuid"),w=u.text||"엑셀 가져오기",d.isOlderBrowser()){if(!u.supportOlderBrowser)return void u.unsupportBrowser();a("#xg-form-"+x).remove(),i=a("<form style='display:inline-block' id='xg-form-"+x+"' name='xg-form-"+x+"' encType='multipart/form-data' action='"+v.actionUrl+"' target='xg-iframe-"+x+"' method='POST' accept-charset='UTF-8'><input type='hidden' name='DS_HEADER'><div style='display:inline-block;'>"+w+'<input type="file" name="EXCEL_FILE" style="position:absolute;top:0;right:0;margin:0;opacity:0;-ms-filter:\'alpha(opacity=0)\';direction:ltr;cursor:pointer;width:100%;height:100%;display:block;"></div></form>'+("<iframe style='display:none;' id='xg-iframe-"+x+"' name='xg-iframe-"+x+"'></iframe>")),A.before(i),A.css("display","none"),q=i.find("div"),q.css({position:"relative"}),e=q.find('input[type="file"]'),e.on("change",function(){var c=a("#xg-form-"+x),e=a("#xg-iframe-"+x);B.startCb&&"function"==typeof B.startCb&&B.startCb(),e.off("load"),e.load(function(){var c,e,f,g,h,i=a(this.contentDocument).find("body > pre");if(i.length||(i=a(this.contentDocument).find("body")),e=b.parse(i.html()),e["@issuccess"]){for(f=[],h=e.body.row,c=d.constant.STATUS.INSERT,g=h.length;g--;)h[g]["*xgRowStatus"]=c,f.unshift(j(z,h[g]));y.$eventEmitter.trigger("xg-bind-event",{uuid:x,eventName:"addRow",rowIdx:z.getRowCount(),value:h,rowValue:f,xgDataTableId:z.getId()}),B.endCb&&"function"==typeof B.endCb&&B.endCb()}else alert(e.message||"수신된 데이터가 올바르지 않습니다."),B.endCb&&"function"==typeof B.endCb&&B.endCb()}),i.find('input[name="DS_HEADER"]').val(b.stringify(y.makeJSONHeader(z.getId()))),c.submit()}),B.target=q}else q=a("<button type='button'>"+w+"</button>"),q.attr("data-xg-ref-uuid",A.data("xg-uuid")),A.before(q),A.css("display","none"),q.off("click"),q.on("click",function(){var a=A.clone(!0);return a.on("change",t),a.trigger("click")}),B.target=q;t=function(a){var e,f,g;return B.startCb&&"function"==typeof B.startCb&&B.startCb(),a.stopPropagation(),e=a.target.files[0],g=new FileReader,f=g.readAsBinaryString?!0:!1,g.onload=function(a){var e,g,h,i,j,k,m,p,q,r,s,t,u,w,x,y,A,C,D,E,F,G,H,I,J;if(window.Worker)g=function(a){return"e"===a.data.t?(alert(a.data.d),B.endCb&&"function"==typeof B.endCb&&B.endCb(),!1):o(z,b.parse(a.data.d),B.endCb)},H=new d.WorkerTask(v.xgUIWorkerUrl+"/xg-ui-worker.js",g,"import",[f,v.xlsxUrl+"/xlsx.full.min.js",z.header,a.target.result]),window.XgPlatform.threadPool.addWorkerTask(H);else{for(k=a.target.result,f?G=c.read(k,{type:"binary"}):(e=n(k),G=c.read(btoa(e),{type:"base64"})),y=G.Sheets[G.SheetNames[0]],A=y["!ref"].split(":"),i=Object.keys(y),p=[],q=0,r=i.length;r>q;++q)h=i[q],"!ref"!==h&&(s=parseInt(h.replace(/[^0-9]/g,""),10),1===s&&p.push({key:h.replace(/\B[0-9]/g,""),value:y[h].v}));for(E=parseInt(A[0].replace(/[^0-9]/g,""),10),C=parseInt(A[1].replace(/[^0-9]/g,""),10),x=[],D=E+1,F=C;F>=D;++D){for(t={},q=0,r=p.length;r>q;++q)m=p[q],j=y[m.key+D],j&&(t[m.value]=j.v);Object.keys(t)&&x.push(t)}for(J=[],u=0,w=x.length;w>u;++u)t=x[u],x[u]["*xgRowStatus"]=d.constant.STATUS.INSERT,I=l(bindedDataTable,t),J.push(I);k={rows:x.reverse(),xgRows:J.reverse()},o(z,k,B.endCb),B.endCb&&"function"==typeof B.endCb&&B.endCb()}},f?g.readAsBinaryString(e):g.readAsArrayBuffer(e)}}if("export"===u.type)if(w=u.text||"엑셀 내보내기",f=a("<i class='fa fa-file-excel-o'></i>"),A.text(w),B.target=A,s=u.fileName||"xg-excel-export",A.off("click"),"poi"===u.exportType)m(s,A,v,B,y,z);else if(d.isOlderBrowser()){if(!u.supportOlderBrowser)return void u.unsupportBrowser();m(s,A,v,B,y,z)}else A.on("click",function(){var a,e,f,g,i,j;return B.startCb&&"function"==typeof B.startCb&&B.startCb(),window.Worker?(e=!0,a=function(a){var c;return"e"===a.data.t?(alert(a.data.d),B.endCb&&"function"==typeof B.endCb&&B.endCb(),!1):(c=b.parse(a.data.d),p(c,s,B.endCb))},i=new d.WorkerTask(v.xgUIWorkerUrl+"/xg-ui-worker.js",a,"export",[e,v.xlsxUrl+"/xlsx.full.min.js",z.header,z.body,{fileName:s}]),window.XgPlatform.threadPool.addWorkerTask(i)):(f=new h,j=k(z,{fileName:s}),f.SheetNames.push(s),f.Sheets[s]=j,g=c.write(f,{bookType:"xlsx",bookSST:!0,type:"binary"}),p(g,s,B.endCb))});return B.target.xgButton.apply(B.target,arguments)}},i=function(){var b=Array.prototype.slice.call(arguments,0,1)[0],c=Array.prototype.slice.call(arguments,1,2)[0];return c||a(b).xgExcelButton(),c&&a(b).xgExcelButton(c),a(b)},a(document).ready(function(){var b,c,d,e,f,g=a("[data-xg-excel-button]"),h=[];for(e=0,f=g.length;f>e;++e)d=g[e],b=a(d),c=b.data("xg-option"),h.push(c?b.xgExcelButton(c):void 0);return h}),XgPlatform.XgLogger.info(function(){return r+" : load end"}),i})}).call(this);